{% extends 'home.html'%}

{% block content%}
{% csrf_token %}

<style>
  :root{
    --bg: #0b1220;
    --panel: rgba(255,255,255,0.08);
    --panel2: rgba(255,255,255,0.06);
    --border: rgba(255,255,255,0.14);
    --text: #eaf0ff;
    --muted: rgba(234,240,255,0.70);

    --primary: #6d5efc;
    --accent: #4fd1c5;
    --ok: #3ddc97;
    --danger: #ff5a7a;
    --warn: #ffcc66;

    --shadow: 0 14px 40px rgba(0,0,0,0.35);
  }

  body{
    background: radial-gradient(1200px 600px at 20% 10%, rgba(109,94,252,0.25), transparent 60%),
                radial-gradient(900px 500px at 80% 30%, rgba(79,209,197,0.18), transparent 55%),
                var(--bg);
    color: var(--text);
  }

  .builder-wrap{
    padding: 28px 16px 60px;
  }

  /* âœ… ONE COLUMN so Saved Models appears BELOW Model Builder */
  .builder-grid{
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    margin-top: 30px;
    align-items: start;

    /* optional: center content + cap max width */
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }

  .panel{
    background: linear-gradient(180deg, var(--panel), var(--panel2));
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  /* optional: keep builder panel slightly narrower than table list */
  .panel.builder-panel{
    max-width: 640px;
  }

  .panel-header{
    padding: 18px 18px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.10);
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
  }

  .panel-title{
    margin: 0;
    font-size: 16px;
    font-weight: 800;
    letter-spacing: .2px;
    display:flex;
    align-items:center;
    gap: 10px;
  }

  .dot{
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: var(--primary);
    box-shadow: 0 0 0 6px rgba(109,94,252,0.18);
  }

  .chip{
    font-size: 12px;
    color: rgba(255,255,255,0.85);
    background: rgba(79,209,197,0.14);
    border: 1px solid rgba(79,209,197,0.28);
    padding: 6px 10px;
    border-radius: 999px;
    white-space: nowrap;
  }

  .panel-body{
    padding: 18px;
  }

  label{
    color: var(--muted);
    font-weight: 750;
    margin-bottom: 8px;
  }

  .form-control, .form-check-input{
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.14);
    color: var(--text);
    border-radius: 12px;
    padding: 12px 14px;
    height: auto;
    transition: all 0.18s ease;
  }

  .form-control:focus{
    background: rgba(255,255,255,0.08);
    border-color: rgba(109,94,252,0.55);
    box-shadow: 0 0 0 0.2rem rgba(109,94,252,0.18);
    color: var(--text);
  }

  select.form-control option{
    color: #0b1220;
  }

  .row-tight{
    margin-left: -6px;
    margin-right: -6px;
  }
  .row-tight > [class*="col-"]{
    padding-left: 6px;
    padding-right: 6px;
  }

  /* Buttons */
  .btn-primary{
    border: 0;
    border-radius: 14px;
    padding: 12px 14px;
    font-weight: 850;
    letter-spacing: .2px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    box-shadow: 0 12px 24px rgba(109,94,252,0.22);
    transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
  }
  .btn-primary:hover{
    filter: brightness(1.02);
    box-shadow: 0 16px 30px rgba(109,94,252,0.28);
    transform: translateY(-1px);
  }

  .btn-success{
    border: 0;
    border-radius: 14px;
    padding: 10px 14px;
    font-weight: 850;
    background: linear-gradient(90deg, var(--ok), rgba(79,209,197,0.95));
    box-shadow: 0 12px 24px rgba(61,220,151,0.18);
  }

  .btn-outline-success{
    border-radius: 14px;
    padding: 12px 14px;
    font-weight: 850;
    color: rgba(234,240,255,0.92);
    border: 1px solid rgba(61,220,151,0.65);
    background: rgba(61,220,151,0.08);
  }
  .btn-outline-success:hover{
    background: rgba(61,220,151,0.14);
    color: var(--text);
  }

  .divider{
    height: 1px;
    width: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,90,122,0.65), transparent);
    margin: 16px 0;
  }

  /* Layer blocks (generated by JS) */
  #layers-container .row{
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 16px;
    padding: 12px !important;
    margin: 0 0 10px 0;
  }
  #layers-container .btn-danger{
    border-radius: 14px;
    font-weight: 800;
  }

  /* Saved models */
  #model_container h2{
    font-weight: 900;
    letter-spacing: .2px;
    margin: 0 0 12px 0;
    color: rgba(234,240,255,0.92);
  }

  .model-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.05));
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 12px;
  }
  .model-card-head{
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.10);
    display:flex;
    justify-content: space-between;
    gap: 10px;
    align-items: center;
  }
  .model-name{
    font-weight: 900;
    margin: 0;
  }

  .pill{
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.06);
    color: rgba(234,240,255,0.9);
    font-size: 12px;
    font-weight: 800;
    margin-right: 6px;
  }
  .pill.primary{ border-color: rgba(109,94,252,0.35); background: rgba(109,94,252,0.14); }
  .pill.warn{ border-color: rgba(255,204,102,0.35); background: rgba(255,204,102,0.14); }

  .model-card-body{
    padding: 14px 16px;
  }

  #model_container .table{
    color: var(--text);
    background: rgba(255,255,255,0.03);
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.08);
    margin-bottom: 0;
  }
  #model_container .table th{
    background: rgba(255,255,255,0.06);
    color: rgba(234,240,255,0.80);
    border-bottom: 1px solid rgba(255,255,255,0.10);
    font-weight: 900;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: .6px;
  }
  #model_container .table td{
    border-top: 1px solid rgba(255,255,255,0.08);
    vertical-align: middle;
  }

  .hint{
    color: rgba(234,240,255,0.72);
    background: rgba(255,255,255,0.05);
    border: 1px dashed rgba(255,255,255,0.18);
    border-radius: 14px;
    padding: 12px;
    font-size: 13px;
    line-height: 1.35;
  }

  /* Switch */
  .form-switch .form-check-input{
    width: 46px;
    height: 24px;
    border-radius: 999px;
  }

  /* spacing helper */
  .sp-12{ height: 12px; }
  .sp-14{ height: 14px; }
</style>

<div class="builder-wrap">
  <div class="builder-grid">

    <!-- Model Builder (top) -->
    <div class="panel builder-panel">
      <div class="panel-header">
        <div class="panel-title"><span class="dot"></span>Model Builder</div>
        <span class="chip">DNN JSON</span>
      </div>

      <div class="panel-body">
        <label for="txtmodelname">Model Name</label>
        <input class="form-control" id="txtmodelname" placeholder="e.g. MyDenseNet" type="text"/>

        <div class="divider"></div>

        <div id="modelparameters">
          <button id="btnAddLayer" class="btn btn-success" style="width:100%;">+ Add Layer</button>

          <div class="sp-12"></div>

          <label for="txtinputshape">Input Shape</label>
          <input class="form-control" id="txtinputshape" placeholder="e.g. 128" type="number"/>

          <div class="sp-12"></div>
          <div id="layers-container"></div>

          <label for="txtoutputshape">Output Shape</label>
          <input class="form-control" id="txtoutputshape" placeholder="e.g. 10" type="number"/>
        </div>

        <div class="sp-14"></div>

        <div class="row row-tight">
          <div class="col-lg-6">
            <label for="selectLoss">Loss</label>
            <select id="selectLoss" class="form-control">
              <option>Loss</option>
              <option>mean_squared_error</option>
              <option>mean_absolute_error</option>
              <option>sparse_categorical_crossentropy</option>
              <option>categorical_crossentropy</option>
            </select>
          </div>
          <div class="col-lg-6">
            <label for="selectOptimizer">Optimizer</label>
            <select id="selectOptimizer" class="form-control">
              <option>Optimizer</option>
              <option>SGD</option>
              <option>RMSprop</option>
              <option>Adam</option>
              <option>Adagrad</option>
              <option>Adadelta</option>
              <option>Adamax</option>
              <option>Nadam</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          <b>Tip:</b> You can either build the model layer-by-layer, or enable file upload to submit a saved JSON model.
        </div>

        <div class="sp-12"></div>

        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="checkfileupload">
          <label class="form-check-label" for="checkfileupload" style="margin-left: 8px;">Upload File?</label>
        </div>

        <div id="divuploadmodel" style="margin-top: 10px;">
          <label class="form-label" for="btnuploadmodel">Upload Model (JSON file)</label>
          <input type="file" class="form-control" id="btnuploadmodel" />
        </div>

        <div class="sp-14"></div>
        <button id="btnBuildModel" class="btn btn-outline-success" style="width:100%;">Build Model</button>
      </div>
    </div>

    <!-- Saved Models (below) -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <span class="dot" style="background: var(--accent); box-shadow:0 0 0 6px rgba(79,209,197,0.16);"></span>
          Saved Models
        </div>
        <span class="chip">Library</span>
      </div>
      <div class="panel-body">
        <div id="model_container">
          <h2>Saved Models</h2>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- JavaScript code for building and displaying the model -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>

<script type="text/javascript">
  var csrf = $('input[name =csrfmiddlewaretoken]').val();

  // Function to add a layer to the UI
  let layerCount = 0;
  total_layers = 0

  function CreateElement(name,id, classes){
    htmlelement = document.createElement(name);
    htmlelement.id = id;
    for(let i = 0; i<classes.length; i++){
      htmlelement.classList.add(classes[i])
    }
    return htmlelement
  }
  function create_select(element, options_list ){
    for (let i = 0; i < options_list.length; i++) {
      const option = document.createElement('option');
      option.value = options_list[i];
      option.text = options_list[i];
      element.appendChild(option);
    }
    return element
  }

  function addLayer() {
    layerCount++;
    total_layers++;

    const layerDiv = CreateElement('div',`layer-${layerCount}`,  ['row'])
    layerDiv.setAttribute('style','padding:10px;')

    numNeuronsInput = CreateElement('input',`txtneurons-${layerCount}`,['form-control'])
    numNeuronsInput.type = 'number';
    numNeuronsInput.value = 128;
    col_neurons = CreateElement('div',`neuron-div-${layerCount}`,['col-2'])
    col_neurons.appendChild(numNeuronsInput);
    layerDiv.appendChild(col_neurons)

    // Add Activation
    activationSelect = CreateElement('select',`selectactivation-${layerCount}`,['form-control'])
    const activationOptions = ['activation','relu', 'sigmoid', 'tanh'];
    activationSelect = create_select(activationSelect, activationOptions)
    col_activation = CreateElement('div',`activation-div-${layerCount}`,['col-2'])
    col_activation.appendChild(activationSelect);
    layerDiv.appendChild(col_activation)

    // Add Kernel Init
    kernelInitializerSelect = CreateElement('select',`selectkernelInitializer-${layerCount}`,['form-control'])
    const kernelInitializerOptions = ['kernelInitializer', 'glorotNormal', 'glorotUniform', 'heNormal', 'heUniform', 'randomNormal', 'randomUniform'];
    kernelInitializerSelect = create_select(kernelInitializerSelect, kernelInitializerOptions)
    col_kernelInitializer = CreateElement('div',`kernelInitializer-div-${layerCount}`,['col-2'])
    col_kernelInitializer.appendChild(kernelInitializerSelect);
    layerDiv.appendChild(col_kernelInitializer)

    // Add biasInitializer
    biasInitializerSelect = CreateElement('select',`selectbiasInitializer-${layerCount}`,['form-control'])
    const biasInitializerOptions = ['biasInitializer', 'zeros', 'ones', 'randomNormal', 'randomUniform'];
    biasInitializerSelect = create_select(biasInitializerSelect, biasInitializerOptions)
    col_biasInitializer = CreateElement('div',`biasInitializer-div-${layerCount}`,['col-2'])
    col_biasInitializer.appendChild(biasInitializerSelect);
    layerDiv.appendChild(col_biasInitializer)

    col_removebtn = document.createElement('div');
    col_removebtn.classList.add('col-3')
    const removeButton = document.createElement('button');
    removeButton.classList.add('remove-layer','btn','btn-danger');
    removeButton.textContent = 'Remove layer';
    removeButton.onclick = () => removeLayer(layerDiv.id)

    col_removebtn.appendChild(removeButton)
    layerDiv.appendChild(col_removebtn)

    // Add the layer div to the container div
    const layersContainer =$('#layers-container');
    layersContainer.append(layerDiv);
  }

  function removeLayer(layerElement) {
    layer_ = document.getElementById(layerElement)

    layer_.animate([
      { opacity: 1 },
      { opacity: 0, transform: "scale(0.5)" }
    ], {
      duration: 500,
      easing: "ease-out"
    }).onfinish = function() {
      layer_.remove()
    };
    total_layers --;
  }

  // Function to build the model based on user input
  async function buildModel() {
    const layersContainer = document.getElementById('layers-container');

    const model = tf.sequential();
    model.dispose();

    flag = false
    for (let i = 1; i <= total_layers; i++) {
      const layerDiv = layersContainer.children[i-1];
      const numNeurons = parseInt(layerDiv.children[0].children[0].value);
      const activation = layerDiv.children[1].children[0].value;
      if(numNeurons == '' || activation == 'activation'){
        flag = true
      }
    }

    input_shape = document.getElementById('txtinputshape').value
    output_shape = document.getElementById('txtoutputshape').value
    model_name = document.getElementById('txtmodelname').value
    loss = document.getElementById('selectLoss').value
    optimizer = document.getElementById('selectOptimizer').value

    if(input_shape == '' || output_shape == '' || model_name == ''){
      flag = true
    }

    if(flag == true){
      alert('ValueError: Model Name, Input shape, Output shape, Number of Neurons and Activation function are required for earch layer')
      return
    }
    if(loss == '' || optimizer == ''){
      alert('ValueError: Model loss and optimizer are required')
      return
    }

    for (let i = 1; i <= total_layers; i++) {
      const layerDiv = layersContainer.children[i-1];
      const numNeurons = parseInt(layerDiv.children[0].children[0].value);
      const activation = layerDiv.children[1].children[0].value;

      kernelinit = layerDiv.children[2].children[0].value;
      baisinit = layerDiv.children[3].children[0].value;
      if(kernelinit == 'kernelInitializer'){
        kernelinit = 'glorotNormal';
      }
      if(baisinit == 'biasInitializer'){
        baisinit = 'zeros';
      }
      if(i==1){
        model.add(tf.layers.dense({
          inputShape: [parseInt(input_shape)],
          units: numNeurons,
          activation: activation,
          kernelInitializer: kernelinit,
          biasInitializer: baisinit
        }));
      }else{
        model.add(tf.layers.dense({
          units: numNeurons,
          activation: activation,
          kernelInitializer: kernelinit,
          biasInitializer: baisinit
        }));
      }
    }

    model.add(tf.layers.dense({ units: parseInt(output_shape) }));
    model.compile({optimizer: 'adam', loss: 'meanSquaredError'});
    model.summary()

    const modelJson = model.toJSON();
    let modelJsonString = JSON.stringify(modelJson);

    $.ajax({
      data: {
        model: modelJsonString,
        model_name: model_name,
        loss: loss,
        optimizer: optimizer,
        r_type: 'save_json_model',
        csrfmiddlewaretoken : csrf
      },
      type: 'POST',
      url: '/APIs'
    }).done(function(data){
      if(data.status == 1){
        alert('Model added successfully')
      }else{
        alert('Failed to add model')
      }
    });
  }

  $("#btnAddLayer").click(function(){ addLayer() });
  $("#btnBuildModel").click(function(){
    c = $('#checkfileupload').is(':checked')
    if(c){
      upload_model_file()
    }else{
      buildModel()
    }
  });

  function json_validator(file){
    var fileName = file.name;
    var fileExtension = fileName.substr(fileName.lastIndexOf('.') + 1).toLowerCase();

    if (fileExtension === 'json') {
      var reader = new FileReader();
      reader.onload = function(e) {
        try { JSON.parse(e.target.result); return 1 }
        catch (error) { return 0 }
      };
      reader.readAsText(file);
    } else {
      return -1
    }
  }

  function upload_model_file(){
    var fileInput = document.getElementById('btnuploadmodel');
    var file = fileInput.files[0];

    model_name = document.getElementById('txtmodelname').value
    loss = document.getElementById('selectLoss').value
    optimizer = document.getElementById('selectOptimizer').value

    if(loss == '' || optimizer == '' || model_name == ''){
      alert('ValueError: Model name, loss and optimizer are required')
      return
    }

    if (file) {
      c = json_validator(file)
      if(c == 0){
        alert('Invalid JSON file'); return
      }else if(c == -1){
        alert('File is not in JSON format'); return
      }else{
        var reader = new FileReader();
        reader.onload = function(e) {
          var contents = e.target.result;
          var modelJson = JSON.parse(contents);

          let modelJsonString = JSON.stringify(modelJson);
          modelJsonString = `"`+modelJsonString+`"`

          $.ajax({
            data: {
              model: modelJsonString,
              model_name: model_name,
              loss: loss,
              optimizer: optimizer,
              r_type: 'save_json_model',
              csrfmiddlewaretoken : csrf
            },
            type: 'POST',
            url: '/APIs'
          }).done(function(data){
            if(data.status == 1){
              alert('Model added successfully')
            }else{
              alert('Failed to add model')
            }
          });
        };
        reader.readAsText(file, 'utf-8');
      }
    } else {
      alert("No file selected.");
    }
  }

  function List_models(model){
    inputshape = 0
    outputshape = 0
    fetched_layers = []
    layers = model['config']['layers']
    for (let i = 0; i < layers.length; i++) {
      var layer = {};
      layer['type'] = layers[i]['class_name']
      layer['units'] = layers[i]['config']['units']
      layer['activation'] = layers[i]['config']['activation']
      layer['use_bias'] = layers[i]['config']['use_bias']
      layer['kernel_initializer'] = layers[i]['config']['kernel_initializer']['class_name']
      layer['bias_initializer'] = layers[i]['config']['bias_initializer']['class_name']
      layer['trainable'] = layers[i]['config']['trainable']
      if(i == 0){
        inputshape = layers[i]['config']['batch_input_shape']
        layer['inputshape'] = inputshape
      }
      if(i== layers.length -1){
        outputshape = layers[i]['config']['units']
        layer['outputshape'] = outputshape
      }
      fetched_layers.push(layer)
    }
    return [inputshape, outputshape, fetched_layers]
  }

  // Updated markup to match theme
  function create_models_div(model_name,inputshape, outputshape, layers_info){
    model_div = $('#model_container')

    let m = `
      <div class="model-card">
        <div class="model-card-head">
          <p class="model-name">Model: ${model_name}</p>
          <div>
            <span class="pill primary">Input ${inputshape}</span>
            <span class="pill warn">Output ${outputshape}</span>
          </div>
        </div>
        <div class="model-card-body">
          <table class="table">
            <tr>
              <th>#</th>
              <th>Type</th>
              <th>Units</th>
              <th>Activation</th>
              <th>use_bias</th>
              <th>kernel_init</th>
              <th>bias_init</th>
              <th>trainable</th>
            </tr>`

    for (let i = 0; i < layers_info.length; i++) {
      m += `
        <tr>
          <td><span class="pill" style="margin:0;">${i}</span></td>
          <td>${layers_info[i]['type']}</td>
          <td>${layers_info[i]['units']}</td>
          <td>${layers_info[i]['activation']}</td>
          <td>${layers_info[i]['use_bias']}</td>
          <td>${layers_info[i]['kernel_initializer']}</td>
          <td>${layers_info[i]['bias_initializer']}</td>
          <td>${layers_info[i]['trainable']}</td>
        </tr>`
    }

    m += `</table></div></div>`
    model_div.append(m)
  }

  function get_models_dnn(){
    $.ajax({
      data: {
        r_type: 'get_models_dnn',
        csrfmiddlewaretoken : csrf
      },
      type: 'POST',
      url: '/APIs'
    }).done(function(data){
      $.each(data.models , async function(i,val){
        model_name = val[1]
        model_info = val[2]
        fetched_layers = List_models(model_info)
        inputshape = fetched_layers[0]
        outputshape = fetched_layers[1]
        layers_info = fetched_layers[2]
        create_models_div(model_name,inputshape, outputshape, layers_info)
      });
    });
  }
  get_models_dnn()

  $('#checkfileupload').click(function() {
    if ($(this).is(':checked')) {
      $('#modelparameters').find('*').prop('disabled', true);
      $('#divuploadmodel').find('*').prop('disabled', false);
    } else {
      $('#modelparameters').find('*').prop('disabled', false);
      $('#divuploadmodel').find('*').prop('disabled', true);
    }
  });
</script>

{% endblock content%}
